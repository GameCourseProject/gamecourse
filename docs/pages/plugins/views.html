<a name="ViewsParts"></a>
<h1>Views</h1>
<div class="section">
    <p>Views allow control over what is displayed in the system. The admins of the course are able to change the registered views in the ways that best suit them.</p>
    <h2>Types</h2>
    <div class="section">
        <p>There are three types of views that can be <a href="#ViewsRegisterView">registered</a>:</p>
        <ul>
            <li><code>Single</code> - simple page that can be configured</li>
            <li><code>Role - Single</code> - page that changes according to the viewer</li>
            <li><code>Role - Interaction</code> - page that changes according to a user and the viewer</li>
        </ul>
    </div>
    <h2>Specializations</h2>
    <div class="section">
        <p>For the views that rely on a role/user, specializations can be configured in each view tab registered in the Settings menu under the Views general tab. The specializations of roles inherit from other roles according the roles hierarchy, so it is possible to have something in a view that is only shown to a certain user or group of users with a role.</p>
    </div>
    <a name="ViewsRegisterView"></a>
    <h2>Registering a view</h2>
    <div class="section">
        <p>To register a new view all that is required is to get the view handler from the <code>views</code> module and use the <code>registerView</code> method with the correct parameters.</p>
        <p>Example:</p>
        <pre class="code">
$viewHandler->registerView($this, 'mycustomview', 'My Custom View', array(
    'type' => ViewHandler::VT_ROLE_INTERACTION
));</pre>
    </div>
</div>
<a name="ViewsParts"></a>
<h1>Views - Parts</h1>
<div class="section">
    <a name="PartValue"></a>
    <h2>Part - Value</h2>
    <div class="section">
        <p>This part allows to display a text.</p>
        <h3>Type - Text</h3>
        <div class="section">
            <p>The <code>Text</code> type provides a simple text that is static and will always appear the same way.</p>
        </div>
        <h3>Type - Field</h3>
        <div class="section">
            <p>The <code>Field</code> type provides an easy way of accessing fields from the database. It starts by searching for the value and configuring the different keys necessary for the maps. The format allow to format the string for example appending something, or repeating the value. The key for the value in the format is <code>%v</code>.</p>
        </div>
        <h3>Type - Expression</h3>
        <div class="section">
            <p>The <code>Expression</code> type provides an advanced way of writing text, it uses the power of the <a href="#ViewsExpressions">Views Expressions</a> to output highly dynamic text.</p>
        </div>
        <h3>Link</h3>
        <div class="section">
            <p>When enabled, this allows to define a HTML link for the text. This link can be something complex using an Expression.</p>
        </div>
    </div>
    <h2>Part - Image</h2>
    <div class="section">
        <p>This part is similar to the <a href="#PartValue">Value</a> part. However it produces an image instead of text.</p>
    </div>
    <a name="PartBlock"></a>
    <h2>Part - Block</h2>
    <div class="section">
        <p>This part is the main component of any view as it is a container for other parts.</p>
        <a name="PartBlockHeader"></a>
        <h3>Header</h3>
        <div class="section">
            <p>The header, when enabled, displays an image and a text, that serve as the title of the block.</p>
        </div>
        <a name="PartBlockHeaderPageAnchor"></a>
        <h3>Header - Page Anchor</h3>
        <div class="section">
            <p>The Page Anchor defines a non-visible element that is an HTML anchor, that can be used by to jump straight to that part with a link.</p>
        </div>
    </div>
    <a name="PartTable"></a>
    <h2>Part - Table</h2>
    <div class="section">
        <p>This part is a simple table with columns and rows.</p>
        <a name="PartTableFilter"></a>
        <h3>Filter</h3>
        <div class="section">
            <p>The Filter, when enabled, will allow the user to filter in real time by some variable defined in the <code>Filter</code> input box. This <a href="#ViewsStyleMiscData">variable must then be defined</a> in every row of the table as a JavaScript variable. It has 2 modes of filtering:</p>
            <ul>
                <li>Hide - which will hide the items that do not pass the filter</li>
                <li>Fade - which will fade the items that do not pass the filter</li>
            </ul>
        </div>
        <a name="PartTableSort"></a>
        <h3>Sort</h3>
        <div class="section">
            <p>The Sort, when enabled, will allow sorting of the columns. There are column by column settings that allow for a finer control of which columns can be sorted, or the default sorting.</p>
        </div>
    </div>
    <a name="PartRegisterNew"></a>
    <h2>Registering a new Part</h2>
    <div class="section">
        <p>To implement a new kind of part in the views, it is required to <a href="#ModuleCreation">write a Module</a> which will have a JavaScript file which takes care of the runtime of the module and in it must be registered in the PHP in order to process the saving, loading, parsing and processing of the part.</p>
        <p>First it is necessary to register the part in the system using the function <code>registerPartType($partType, $breakFunc, $putTogetherFunc, $parseFunc, $processFunc)</code> from the <code>\Modules\Views\ViewHandler</code> class. This allows the system to recognize the part and process it according to the functions provided. An example of this can be found <a href="pages/examples/view-part-php.txt">here</a>.</p>
        <p>Next we need to register the part in the front-end of the system, using JavaScript. To do this, we use the <code>$sbviews</code> angular service, provided by the views module. An example of the JavaScript file can be found <a href="pages/examples/view-part-js.txt">here</a>.</p>
    </div>
</div>
<a name="ViewsPartSettings"></a>
<h1>Views - Part Settings</h1>
<div class="section">
    <a name="ViewsDOMIf"></a>
    <h2>DOM Manipulation - If</h2>
    <div class="section">
        <p>The If option is used to choose when to or not to display a certain part. When the <code>Condition</code> expression is evaluated as <code>false</code> the element will not be visible.</p>
        <h3>Example</h3>
        <div class="section">
            <p>One example of this is to display a Notice. Lets say that the students need to enroll for some activity and you want to alert them. A block with a If option could be created to show the alert message when the enrollment has started.</p>
            <img src="./pages/plugins/views_example_if.png">
            <p>The expression uses the <code>$time</code> function to return the current time. The time is than compared with the number specified as a timestamp, and in the case the condition returns true, the block is displayed.</p>
        </div>
    </div>
    <a name="ViewsDOMRepeat"></a>
    <h2>DOM Manipulation - Repeat</h2>
    <div class="section">
        <p>The Repeat part option allows the part to be repeated using some container (array or map) as the provider of the items. The <code>Elements</code> field must contain an expression that returns one such container. And the <code>Key</code> field must contain a simple string (only letters A through Z), that which will define a few <a href="#ViewsExpressionVariables">Expression Variables</a>. The variables are:</p>
        <ul>
            <li><code>&lt;key&gt;key</code> - original key of the array or map;</li>
            <li><code>&lt;key&gt;pos</code> - sorted position of the item in array or map;</li>
            <li><code>&lt;key&gt;</code> - Continuation of the value of the item.</li>
        </ul>
        <p>When enabled, the Filter option allows to filter items from the container, repeating only for the items for which the expression defined in the <code>Filter</code> field is evaluated as <code>true</code>.</p>
        <p>The Sort option allows to sort the items of the container, according to the resulting value of the Expression in the <code>Value</code> field. It is possible to change the direction of the sort, using the <code>Order</code> select box.</p>
        <p><strong>Note</strong>: The repeat position variable can not be used in the expressions of the <code>Filter</code> field, nor in the sort <code>Value</code> field.</p>
        <h3>Example</h3>
        <div class="section">
            <p>For example, to configure a list like the leaderboard, we would do this: </p>
            <img src="./pages/plugins/views_example_repeat.png">
            <p>The Elements expression will repeat for all users in the course and assign them to the variable student. This Elements are filtered using the Filter expression to contain only the users that have "Student" in their roles, and sorted using the XP data value.</p>
        </div>
    </div>
    <a name="ViewsStyleMiscStyle"></a>
    <h2>Styling/Misc - Style</h2>
    <div class="section">
        <p>Using the <code>Style</code> expression field it is possible to change the way parts look in the view. It is simple to add a CSS rule to manipulate the part as we wish.</p>
    </div>
    <a name="ViewsStyleMiscClass"></a>
    <h2>Styling/Misc - Class</h2>
    <div class="section">
        <p>The <code>Class</code> expression field is similar to the Style, however it requieres the user to <a href="#ModuleCreation">write a Module</a> and <a href="#ModuleSetupResources">setup the CSS file</a> containing the CSS classes.</p>
    </div>
    <a name="ViewsStyleMiscAngularDirective"></a>
    <h2>Styling/Misc - Angular Directive</h2>
    <div class="section">
        <p>The <code>Angular Directive</code> expression field is used to specify an AngularJS directive to be used in the part. This is a necessary part for the use of Events. However, it is required to <a href="#ModuleCreation">write a Module</a> and <a href="#ModuleSetupResources">setup a JS file</a> to use this feature.</p>
    </div>
    <a name="ViewsStyleMiscEvents"></a>
    <h2>Styling/Misc - Events</h2>
    <div class="section">
        <p>The <code>Events</code> option allows to control the interaction of the user with the Parts. To add an event select an event from the list, and press <code>Add</code>. In the box next to the event name, write an Angular Expression to be evaluated in the scope of the part. To have a custom function to be called in the scope, it is necessary to define an <a href="#ViewsStyleMiscAngularDirective">Angular Directive</a>.</p>
    </div>
    <a name="ViewsStyleMiscData"></a>
    <h2>Styling/Misc - Data</h2>
    <div class="section">
        <p>The <code>Data</code> option allows to define variables that are can be used for other features of the views. After adding a new key, it is possible to define an expression in the box next to the key name. This expression will be evaluated and the value will be saved in the variable.</p>
        <p>Using the selection box that is present after the Expression box, it is possible to select the context of the variable. If the context is <code>JavaScript</code>, the variable will be stored in the Data of the element in the DOM, which can be easily accessed from a Angular Directive or a function that is defined for an Event. In the case of the context <code>Variable</code> the variable is used by the PHP expression evaluator, and can be used to define variables to use in the part or its children, if the part allows.</p>
    </div>
</div>
<a name="ViewsExpressions"></a>
<h1>Views - Expressions</h1>
<div class="section">
    <a name="FirstSteps"></a>
    <h2>First Steps</h2>
    <div class="section">
        <p>To configure the SmartBoards views in an advanced way, it is required to learn how to use Expressions, which are very similar to a programming language.</p>
        <p>An example of such expression is <code>Hello {users[%viewer].name}!</code> which would be evaluated as 'Hello John!', for example, if the name of the viewer was John.</p>
        <p>
            Let's break down how it works. Anything you type is accepted as text, except if it starts with a <code>%</code> (percentage) which will get the value of a variable. To escape this case use <code>%%</code>.
            When you want to evaluate something it should be placed inside curly brackets, for example, <code>{2*3}</code>. To access the name of the viewer as we demonstrated in the first example, we use <code>{users[%viewer].name}</code> which basically goes to the <strong>map of users</strong> gets the one with the key <strong>%viewer</strong> (which is evaluated as the id of the viewer, predefined by the view) and them returns the <strong>name</strong> of that user. The data schema can be viewed in the <a href="./schema">Schema documentation page</a>.
        </p>
    </div>
    <h2>Operations/Functions</h2>
    <div class="section">
        <p>
            As in many other languages the expressions provide the simple mathematics operators for addition <code>+</code>, subtraction <code>+</code>, multiplication <code>*</code>, division <code>/</code> and modulo <code>%</code>.
            It also provides logic and bitwise operators, and <code>&&</code> (bitwise <code>&</code>), or <code>||</code> (bitwise <code>|</code>), negation <code>!</code> (bitwise <code>~</code>) and bitwise xor <code>^</code>.
        </p>
        <p>It is also possible to call functions defined in PHP from the expressions. A function call starts with <code>$</code> and is followed by an arbitrary number of letters, A through Z. The arguments of the function are enclosed in parentesis <code>()</code> and need to be comma separated.</p>
        <p>These functions need to be <a href="#ViewsExpressionDevelopFunction">registered by a module</a>, however there are some predefined functions:</p>
        <ul>
            <li>$value(continuation) - Returns the value of the continuation</li>
            <li>$size(array/map) - Returns the size of the map or array</li>
            <li>$urlify(string) - Removes Spaces of a String</li>
            <li>$time() - Returns a timestamp</li>
            <li>$formatDate(string time) - Returns the time formated</li>
            <li>$if(cond, valueOne, valueTwo) - Executes a if condition</li>
            <li>$isModuleEnabled(module) - Returns true if the module is enabled</li>
            <li>$getModules() - Returns an array continuation with all enabled modules</li>
        </ul>
        <p>Examples (one per line):</p>
        <pre class="code">
$time()
$urlify("Challenger of the Unknown")
$formatDate($time())</pre>
    </div>
    <a name="ViewsExpressionVariables"></a>
    <h2>Variables</h2>
    <div class="section">
        <p>Variables are used by the expressions to allow an easier creation of expressions without having to write very long expressions to access certain fields for example. As discussed in <a href="#FirstSteps">First Steps</a>, a variable starts with a <code>%</code> (percentage symbol) and is followed by an arbitrary number of letters, A through Z.</p>
        <p>The value of a variable can be a single value, for example, a number or a string, but it can also be an object that is returned by a function. There is a special kind of object called a <strong>Continuation</strong> which allow the variable to be used as a path, for example, <code>{%skill.name}</code>, if the skill was a continuation of some other path, provided by a <a href="#ViewsDOMRepeat">DOM Manipulation - Repeat</a> of the view. (For module developers: It is possible to create continuations from arrays with arbitrary keys, for more information, consult <a href="#ReturningContinuation">Returning a Continuation</a>)</p>
    </div>
    <h2>Data Access</h2>
    <div class="section">
        <p>To access the data saved in the SmartBoards system, its just a matter of knowing the path for the data. The data schema can be consulted <a href="./schema">here</a>. To access the data in the path all that is needed is to specify that path inside a expression like <code>{users[12345].name}</code>, which in this case would get the name of the user with id 12345.</p>
        <p>Developers can see how to define accessible data in the data schema <a href="#ModuleDataSchema" aria-label="Define accessible data in Data Schema">here</a>.</p>
    </div>
    <a name="ViewsExpressionDevelopFunction"></a>
    <h2>Developing a function</h2>
    <div class="section">
        <p>Custom functions can be used in the expressions, whoever these must be defined using PHP and a module (if you need to setup the module take a look at the <a href="#FirstSteps">First Steps</a> on how to setup a module). After setting up a module <a href="#ModuleOnInitialization">on the initialization</a> we need <a href="#ModuleInteraction">request the module</a> <code>views</code>, get the view handler and register the function.</p>
        <pre class="code">
public function init() {
    $viewHandler = $this->getParent()->getModule('views')->getViewHandler();
    $viewHandler->registerFunction('concat', function($param1, $param2) {
         return new Modules\Views\Expression\ValueNode($param1 . $param2);
    });
}</pre>
        <p>These functions should return a ValueNode that can be presented on the page, or return a Continuation to be used by other parts and functions.</p>
        <a name="ReturningContinuation"></a>
        <h3>Returning a Continuation</h3>
        <div class="section">
            <p>A continuation can be returned on the function, from an arbitrary PHP array, by using the provided function <code>\Smartboards\DataRetrieverContinuation::buildForArray($array)</code> that will build the necessary structures and return the DataRetrieverContinuation object.</p>
        </div>
    </div>
</div>