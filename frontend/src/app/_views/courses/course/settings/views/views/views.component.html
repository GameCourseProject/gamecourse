<ng-container *ngIf="!loading">

  <!-- Search -->
  <div class="search">
    <input type="text" id="seach_input" placeholder="Search.." name="search" [(ngModel)]="searchQuery" (ngModelChange)="reduceList(searchQuery)">
    <button class="magnifying-glass" id="search-btn" (click)="reduceList(searchQuery)"></button>
  </div>

  <!-- Pages -->
  <div class="section">
    <div class="divider">
      <div class="title"><span>Pages</span></div>
    </div>

    <div class="content" id="pages">
      <div *ngFor="let page of reduceForPages.items" class="card">
        <div class="color_box">
          <div class="box"></div>
          <div class="frame frame-page"></div>
        </div>

        <div class="footer with_status">
          <div class="page_info">
            <span>{{page.name}}</span>
            <span>(id: {{page.id}})</span>
          </div>

          <div class="page_actions">
            <span class="config_icon icon" title="Edit" (click)="editPage(page)"></span>
            <span class="delete_icon icon" (click)="pageSelected = page; isDeleteVerificationModalOpen = true"></span>
          </div>
        </div>

        <div class="status" [ngClass]="{'enable': page.isEnabled, 'disable': !page.isEnabled}">
          {{page.isEnabled ? 'Enabled' : 'Disabled'}}
          <div class="background"></div>
        </div>
      </div>

      <div class="action-buttons" style="width:30px">
        <div class="icon add_icon" title="New" (click)="mode = 'add'; clear(); isPageModalOpen = true;"></div>
      </div>
    </div>

    <div *ngIf="searchQuery && reduceForPages.items.length === 0" class="error_box">
      <div id="empty_pages" class="error_msg">No matches found</div>
    </div>
  </div>

  <!-- View Templates -->
  <div class="section">
    <div class="divider">
      <div class="title"><span>View Templates</span></div>
    </div>

    <div class="content" id="view_templates">
      <div *ngFor="let template of reduceForViewTemplates.items" class="card">
        <div class="color_box">
          <div class="box"></div>
          <div class="frame frame-page">
            <span class="edit_icon" title="Edit" [routerLink]="'templates/' + (template | as : Template).id + '/editor'"></span>
          </div>
        </div>

        <div class="footer">
          <div class="page_name">{{(template | as : Template).name}}</div>
          <div class="template_actions">
            <span class="config_icon icon" title="Edit" (click)="editTemplate(template)"></span>
            <span *ngIf="!(template | as : Template).isGlobal" class="globalize_icon icon" title="Globalize" (click)="globalize(template)"></span>
            <span *ngIf="(template | as : Template).isGlobal" class="de_globalize_icon icon" title="Deglobalize" (click)="globalize(template)"></span>
            <span class="export_icon_no_outline icon" title="Export" (click)="exportTemplate(template)"></span>
            <span class="delete_icon icon" title="Remove" (click)="templateSelected = template; isDeleteVerificationModalOpen = true"></span>
          </div>
        </div>
      </div>

      <div class="action-buttons" style="width:30px">
        <div class="icon add_icon" title="New" (click)="mode = 'add'; clear(); isTemplateModalOpen = true;"></div>
      </div>
    </div>

    <div *ngIf="searchQuery && reduceForViewTemplates.items.length === 0" class="error_box">
      <div id="empty_templates" class="error_msg">No matches found</div>
    </div>
  </div>

  <!-- Global Templates -->
  <div class="section">
    <div class="divider">
      <div class="title"><span>Global Templates</span></div>
    </div>

    <div class="content" id="global_templates">
      <div *ngFor="let template of reduceForGlobalTemplates.items" class="card">
        <div class="color_box">
          <div class="box"></div>
          <div class="frame frame-page">
            <span *ngIf="(template | as : Template).courseId !== courseID" class="add_icon_no_outline"
                  (click)="useGlobal(template)"></span>
          </div>
        </div>

        <div class="footer">
          <div class="page_name">{{template.name}}</div>
        </div>
      </div>
    </div>

    <div *ngIf="searchQuery && reduceForGlobalTemplates.items.length === 0" class="error_box">
      <div id="empty_globals" class="error_msg">No matches found</div>
    </div>
  </div>

</ng-container>

<!-- Loader -->
<div *ngIf="loading" id="page-loading">
  <img src="../../../../../../../assets/loader/loader.gif" alt="loader">
</div>


<!-- New / Edit Page Modal -->
<ng-container *ngIf="isPageModalOpen">
  <app-modal
    [isModalOpen]="isPageModalOpen"
    [id]="mode === 'add' ? 'new-view' : 'edit-view'"
    [templateRef]="newPageModal"
    (closeBtnClicked)="isPageModalOpen = false; clear()"
    [actionInProgress]="saving">
  </app-modal>
</ng-container>

<ng-template #newPageModal>

  <div class="title">{{mode === 'add' ? 'New' : 'Edit'}} page:</div>

  <div class="content">
    <div class="inputs" style="padding-bottom: 26px">
      <!-- Name -->
      <div class="name full">
        <input type="text" class="form__input" id="page_name" placeholder="Name *" [(ngModel)]="pageSelected.name">
        <label for="page_name" class="form__label">Name</label>
      </div>

      <!-- View template -->
      <select class="form__input pages_info" [(ngModel)]="pageSelected.viewId">
        <option [ngValue]="null" disabled selected>Select a view template *</option>
        <option *ngFor="let template of allViewTemplates" [ngValue]="template.viewId" label="{{template.name}}">{{template.name}}</option>
      </select>
    </div>

    <div id="active_page" class="row">
      <div class="on_off">
        <span>Enable Page</span>
        <label class="switch">
          <input type="checkbox" [checked]="pageSelected.isEnabled" (change)="pageSelected.isEnabled = !pageSelected.isEnabled">
          <span class="slider round"></span>
        </label>
      </div>
    </div>

    <button class="cancel" (click)="isPageModalOpen = false; clear()"> Cancel </button>
    <button class="save_btn" (click)="savePage(pageSelected)" [disabled]="!isReadyToSubmit('page')"> Save </button>
  </div>

</ng-template>


<!-- New / Edit Template Modal -->
<ng-container *ngIf="isTemplateModalOpen">
  <app-modal
    [isModalOpen]="isTemplateModalOpen"
    [id]="mode === 'add' ? 'new-view' : 'edit-view'"
    [templateRef]="newTemplateModal"
    (closeBtnClicked)="isTemplateModalOpen = false; clear()"
    [actionInProgress]="saving">
  </app-modal>
</ng-container>

<ng-template #newTemplateModal>

  <div class="title">{{mode === 'add' ? 'New' : 'Edit'}} template:</div>

  <div class="content">
    <div class="inputs" style="padding-bottom: 26px">
      <!-- Name -->
      <div class="name full">
        <input type="text" class="form__input" id="template_name" placeholder="Name *" [(ngModel)]="templateSelected.name">
        <label for="template_name" class="form__label">Name</label>
      </div>

      <!-- Role Type -->
      <select class="form__input pages_info" id="new_view_role" [(ngModel)]="templateSelected.roleTypeId">
        <option [ngValue]="null" disabled selected>Select a role type *</option>
        <option *ngFor="let type of types" [ngValue]="type.id" label="{{type.name}}">{{type.name}}</option>
      </select>
    </div>

    <button class="cancel" (click)="isTemplateModalOpen = false; clear()"> Cancel </button>
    <button class="save_btn" (click)="saveTemplate(templateSelected)" [disabled]="!isReadyToSubmit('template')"> Save </button>
  </div>

</ng-template>


<!-- Delete Verification Modal -->
<ng-container *ngIf="isDeleteVerificationModalOpen">
  <app-verification-modal
    [isModalOpen]="isDeleteVerificationModalOpen"
    [id]="'delete-view'"
    [text]="'Are you sure you want to delete this ' + (pageSelected ? 'page' : 'template') + '?'"
    [target]="(pageSelected ? 'Page' : 'Template') + ': ' + (pageSelected?.name || templateSelected?.name) + ' (id: ' + (pageSelected?.id || templateSelected?.id) + ')'"
    [positiveBtnText]="'Delete'"
    (positiveBtnClicked)="pageSelected ? deletePage() : deleteTemplate()"
    (negativeBtnClicked)="clear(); isDeleteVerificationModalOpen = false"
    (closeBtnClicked)="isDeleteVerificationModalOpen = false"
    [actionInProgress]="saving">
  </app-verification-modal>
</ng-container>
