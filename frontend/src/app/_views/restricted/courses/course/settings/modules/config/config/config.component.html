<ng-container *ngIf="!loading">

  <!-- Header -->
  <div class="header">
    <div id="name">{{module.name}} Configuration</div>
    <div id="description">{{module.description}}</div>
  </div>

  <!-- General Inputs -->
  <div *ngIf="generalInputs?.length > 0" class="section">
    <div class="divider">
      <div class="title"><span>General</span></div>
    </div>

    <div class="multiple_inputs content">
      <div *ngFor="let input of generalInputs" class="row">
        <ng-container
          [ngTemplateOutlet]="INPUT"
          [ngTemplateOutletContext]="{id: 'value', label: input.label, type: input.type, obj: input, style: 'outer', options: input.options}">
        </ng-container>
      </div>

      <div class="action-buttons">
        <button id="general-inputs-save-button" class="button" [disabled]="!hasUnsavedChanges" (click)="saveGeneralInputs()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Lists -->
  <div *ngIf="lists">
    <div *ngFor="let list of lists" class="section">
      <div class="divider">
        <div class="title"><span>{{list.listName}}</span></div>
      </div>

      <div class="allItems content">
        <ng-container
          [ngTemplateOutlet]="LIST"
          [ngTemplateOutletContext]="{list}">
        </ng-container>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <ng-container *ngFor="let action of list.listActions">
            <div *ngIf="action === Action.NEW" class="icon add_icon" title="New" (click)="mode = 'add'; newItem.list = list; newItem.item = {}; isItemModalOpen = true;"></div>
            <div *ngIf="action === Action.IMPORT" class="icon import_icon" title="Import" (click)="this.isImportModalOpen = true; listToAct = list"></div>
            <div *ngIf="action === Action.EXPORT" class="icon export_icon" title="Export All" (click)="exportItems(list)"></div>
          </ng-container>
        </div>
      </div>

      <div class='success_box'>
        <div id='action_completed' class='success_msg'></div>
      </div>
    </div>
  </div>

  <!-- Personalized Config -->
  <div *ngIf="personalizedConfig" class="personalized-config {{module.id}}">
    <ng-container [ngComponentOutlet]="PersonalizedConfig"></ng-container>
  </div>

</ng-container>

<!-- Loader -->
<div *ngIf="loading || loadingAction" id="page-loading">
  <img src="assets/loader/loader.gif" alt="loader">
</div>


<!-- List Template -->
<ng-template #LIST let-list='list'>
  <div [id]="'list-' + list.listName">
    <div class="data-table">

      <table *ngIf="list.items.length > 0" id="listing-table">
        <!-- Header -->
        <thead>
          <tr>
            <th *ngFor="let column of list.listInfo; let i = index"
                [ngClass]="{'check-column': column.type === InputType.TOGGLE}">
              {{column.label}}
            </th>
            <ng-container *ngFor="let action of list.actions">
              <th *ngIf="showAtLeastOnce(action.scope, list.items.length)" class="action-column"></th>
            </ng-container>
          </tr>
        </thead>

        <!-- Body -->
        <tbody>
          <tr *ngFor="let item of list.items; let i = index; let first = first; let last = last; let even = even; let odd = odd">

            <td *ngFor="let column of list.listInfo"
                [ngClass]="{'check-column': column.type === InputType.TOGGLE}">

              <ng-container *ngIf="column.type === InputType.IMAGE">
                <img [src]="getImage(item[column.id] || API_ENDPOINT + '/' + 'assets/imgs/no-image.png')" alt="{{list.itemName}} image">
              </ng-container>

              <ng-container *ngIf="column.type === InputType.TOGGLE" class="check-column">
                <label class="switch">
                  <input type="checkbox" [(ngModel)]="item[column.id]" (change)="toggleItemParam(list, item)">
                  <span class="slider round"></span>
                </label>
              </ng-container>

              <ng-container *ngIf="column.type === InputType.COLOR">
                <div class="color">
                  <div class="color-sample">
                    <div class="box" [ngStyle]="{'backgroundColor': item[column.id]}"></div>
                  </div>
                  <div *ngIf="column.options['showLabel']">{{item[column.id]}}</div>
                </div>
              </ng-container>

              <ng-container *ngIf="column.type === InputType.DATETIME">
                <span>{{formatDate(item[column.id], 'DD/MM/YYYY HH:mm:ss')}}</span>
              </ng-container>

              <ng-container *ngIf="column.type !== InputType.IMAGE && column.type !== InputType.TOGGLE && column.type !== InputType.COLOR && column.type !== InputType.DATETIME">
                <span>{{item[column.id]}}</span>
              </ng-container>
            </td>

            <ng-container *ngFor="let action of list.actions">
              <td *ngIf="showAtLeastOnce(action.scope, list.items.length)" class="action-column">
                <ng-container *ngIf="scopeAllows(action.scope, list.items.length, i, first, last, even, odd)">
                  <div *ngIf="action.action === Action.DUPLICATE" class="icon duplicate_icon" title="Duplicate" (click)="doActionOnItem(list.listName, item, action.action, list.parent ?? null)"></div>
                  <div *ngIf="action.action === Action.EDIT" class="icon edit_icon" title="Edit" (click)="mode = 'edit'; initEditItem(list, item, i, first, last, even, odd); isItemModalOpen = true;"></div>
                  <div *ngIf="action.action === Action.DELETE" class="icon delete_icon" title="Remove" (click)="itemToDelete = {list, item}; isDeleteVerificationModalOpen = true"></div>
                  <div *ngIf="action.action === Action.VIEW" class="icon preview_icon" title="View" (click)="viewItem(list, item)"></div>
                  <div *ngIf="action.action === Action.MOVE_UP" class="icon up_icon" title="Move up" (click)="moveItem(list, item, 1)"></div>
                  <div *ngIf="action.action === Action.MOVE_DOWN" class="icon down_icon" title="Move down" (click)="moveItem(list, item, -1)"></div>
                  <div *ngIf="action.action === Action.EXPORT" class="icon export_icon_no_outline" title="Export" (click)="exportItems(list, item)"></div>
                </ng-container>
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>

      <div *ngIf="list.items.length === 0" class='error_box'>
        <div id='empty_table' class='error_msg'>No {{list.itemName}}s found</div>
      </div>

    </div>
  </div>
</ng-template>


<!-- New Item / Edit Item -->
<ng-container *ngIf="isItemModalOpen">
<!--  <app-modal-->
<!--    [isOpen]="isItemModalOpen"-->
<!--    [id]="mode === 'add' ? 'new-item' : 'edit-item'"-->
<!--    [templateRef]="itemModal"-->
<!--    (closeBtnClicked)="isItemModalOpen = false; newItem.list = null; clearObject(newItem.item)"-->
<!--    [actionInProgress]="loading"-->
<!--    [innerClickEvents]="false">-->
<!--  </app-modal>-->
</ng-container>

<ng-template #itemModal>
  <!-- Title -->
  <div class="title">{{mode === 'add' ? 'New' : 'Edit'}} {{newItem.list.itemName}}:</div>

  <div class="content">
    <div id="new_box" class="inputs">
      <div class="row-inputs">
        <div class="details full config-item">
          <div *ngFor="let input of newItem.list[Action.EDIT]"
               [ngClass]="{'half': input.type !== InputType.IMAGE && input.type !== InputType.TOGGLE, 'full': input.type === InputType.IMAGE, 'on_off': input.type === InputType.TOGGLE}">

            <ng-container
              *ngIf="scopeAllows(input.scope, newItem.nrItems, newItem.index, newItem.first, newItem.last, newItem.even, newItem.odd)"
              [ngTemplateOutlet]="INPUT"
              [ngTemplateOutletContext]="{id: input.id, label: input.label, type: input.type, obj: newItem.item, style: 'inner', options: input.options}">
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <button class="cancel" (click)="isItemModalOpen = false; newItem.list = null; clearObject(newItem.item)">Cancel</button>
    <button class="save_btn" [disabled]="!hasUnsavedChanges" (click)="doActionOnItem(newItem.list.listName, newItem.item, mode === 'add' ? Action.NEW : Action.EDIT, newItem.list.parent || null)">Save</button>
  </div>
</ng-template>


<!-- Inputs FIXME: create components and an any-input component -->
<ng-template #INPUT let-id='id' let-label='label' let-type='type' let-obj='obj' let-style='style' let-options='options'>

  <!-- Text -->
  <ng-container *ngIf="type === InputType.TEXT">
    <ng-container *ngIf="style === 'outer'">
      <div class="input-wrapper">
        <span *ngIf="label" class="label">{{label}}</span>
        <input type="text" id="{{id}}" name="{{id}}" placeholder="{{label}}" class="input" [(ngModel)]="obj[id]" (ngModelChange)="hasUnsavedChanges = true">
      </div>
    </ng-container>

    <ng-container *ngIf="style === 'inner'">
      <input type="text" id="{{id}}" name="{{id}}" placeholder="{{label}}" class="form__input" [(ngModel)]="obj[id]" (ngModelChange)="hasUnsavedChanges = true">
      <label [for]="id" class="form__label">{{label}}</label>
    </ng-container>
  </ng-container>

  <!-- Number -->
  <ng-container *ngIf="type === InputType.NUMBER">
    <ng-container *ngIf="style === 'outer'">
      <div class="input-wrapper">
        <span *ngIf="label" class="label">{{label}}</span>
        <input type="number" id="{{id}}" name="{{id}}" placeholder="{{label}}" class="input" [(ngModel)]="obj[id]" (ngModelChange)="hasUnsavedChanges = true">
      </div>
    </ng-container>

    <ng-container *ngIf="style === 'inner'">
      <div>
        <input type="number" id="{{id}}" name="{{id}}" placeholder="{{label}}" class="form__input" [(ngModel)]="obj[id]" (ngModelChange)="hasUnsavedChanges = true">
        <label [for]="id" class="form__label">{{label}}</label>
      </div>
    </ng-container>
  </ng-container>

  <!-- Select -->
  <ng-container *ngIf="type === InputType.SELECT">
    <select class="form__input" [(ngModel)]="obj[id]">
      <option [value]="null" disabled>Select {{label}}</option>
      <option *ngFor="let item of options['items']" [value]="item['id']">{{item['labelParam']}}</option>
    </select>
  </ng-container>

  <!-- Toggle -->
  <ng-container *ngIf="type === InputType.TOGGLE">
    <div class="input-wrapper toggle">
      <span *ngIf="label" class="label">{{label}}</span>
      <label class="switch">
        <input type="checkbox" id="{{id}}" name="{{id}}" [(ngModel)]="obj[id]" (ngModelChange)="hasUnsavedChanges = true" [checked]="obj[id]">
        <span class="slider round"></span>
      </label>
    </div>
  </ng-container>

  <!-- Image -->
  <app-input-file *ngIf="type === InputType.IMAGE"
      [id]="id"
      [accept]="'image/*'"
      [label]="label"
      (valueChange)="onFileSelected($event, 'image', obj, id)">
  </app-input-file>

  <!-- Color -->
  <app-input-color *ngIf="type === InputType.COLOR"
      [id]="id"
      [(value)]="obj[id]">
  </app-input-color>

</ng-template>


<!-- Delete Verification Modal -->
<ng-container *ngIf="isDeleteVerificationModalOpen">
<!--  <app-verification-modal-->
<!--    [isModalOpen]="isDeleteVerificationModalOpen"-->
<!--    [id]="'delete-verification-' + itemToDelete.item.id"-->
<!--    [text]="'Are you sure you want to delete this ' + itemToDelete.list.itemName + '?'"-->
<!--    [positiveBtnText]="'Delete'"-->
<!--    (positiveBtnClicked)="doActionOnItem(itemToDelete.list.listName, itemToDelete.item, Action.DELETE)"-->
<!--    (negativeBtnClicked)="itemToDelete = null; isDeleteVerificationModalOpen = false"-->
<!--    (closeBtnClicked)="itemToDelete = null; isDeleteVerificationModalOpen = false"-->
<!--    [actionInProgress]="loading">-->
<!--  </app-verification-modal>-->
</ng-container>


<!-- Import Modal -->
<ng-container *ngIf="isImportModalOpen">
<!--  <app-modal-->
<!--    [isOpen]="isImportModalOpen"-->
<!--    [id]="'import-item'"-->
<!--    [templateRef]="importModal"-->
<!--    (closeBtnClicked)="isImportModalOpen = false; listToAct = null"-->
<!--    [actionInProgress]="loading"-->
<!--    [innerClickEvents]="false"-->
<!--    [classList]="'verification'">-->
<!--  </app-modal>-->
</ng-container>

<ng-template #importModal>

  <div class="warning">Please select a {{listToAct[Action.IMPORT].extensions.length === 1 ? listToAct[Action.IMPORT].extensions[0] + " " : ""}}file to be imported.
                       {{listToAct[Action.IMPORT].extensions.length > 1 ? "Supported file types: " + listToAct[Action.IMPORT].extensions : ""}}</div>
  <div class="target">The separator must be comma <br>The encoding must be UTF-8</div>
  <app-input-file
    [id]="'import_item'"
    [accept]="listToAct[Action.IMPORT].extensions.toString()"
    [classList]="'config_input'"
    (valueChange)="onFileSelected($event, 'file')">
  </app-input-file>

  <div class="confirmation_btns">
    <button (click)="importItems(true)">Import {{listToAct.itemName}}s (Replace Duplicates)</button>
    <button (click)="importItems(false)">Import {{listToAct.itemName}}s (Ignore Duplicates)</button>
  </div>

</ng-template>
