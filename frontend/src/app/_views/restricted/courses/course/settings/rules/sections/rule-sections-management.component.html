<div *ngIf="mode === 'see section'" class="w-full relative">

  <ng-container *ngIf="!loading.page">

    <div class="flex flex-wrap items-center">
      <button type="button" class="btn btn-sm btn-ghost btn-circle" (click)="closeManagement()">
        <ng-icon name="tabler-arrow-narrow-left" size="1.2rem" class="mr-0.5 text-base-content text-opacity-60"></ng-icon>
      </button>
      <span class="text-base-content mt-0.5 text-xs text-opacity-60">Back to <i>'Existing Sections'</i></span>
    </div>


    <div class="divider -mt-2">
      <div class="flex justify-center mx-2">
        <ng-icon name="jam-box" size="1.5rem" class="text-primary mr-2"></ng-icon>
        <span class="text-base-content text-xl font-semibold">{{section.name}}</span>
      </div>
    </div>

    <app-top-actions
      [rightActions]="[{action: 'Create rule', icon: 'tabler-clipboard-list', color: 'primary', outline: true},
                       {action: 'Import / Export', icon: 'tabler-arrows-up-down', color: 'primary', outline: true,  dropdown: [
                        {action: Action.IMPORT + ' rule(s)', icon:'jam-download'},
                        {action: Action.EXPORT + ' all rules', icon:'jam-upload'}
                      ]}]"
      (btnClicked)="prepareModal($event)">
    </app-top-actions>

    <!-- Section Table-->
    <app-table
      *ngIf="section.showTable"
      [id] = "'rules-' + section.id"
      [classList]="'mt-5'"
      [headers] = "section.headers"
      [data] = "section.data"
      [options] = "section.options"
      [loading] = "section.loadingTable"
      (btnClicked)="doActionOnTable($event.type, $event.row, $event.col)"
      (valueChanged)="doActionOnTable('value changed rule', $event.row, $event.col)">
    </app-table>

    <div id="rule-content" *ngIf="!refreshing">
      <div class="card w-full bg-base-100 shadow-xl mt-10"
           *ngIf="(ruleMode === 'add rule' || ruleMode === 'edit rule') && ruleToManage">
        <div class="card-body">
          <div class="card-title flex flex-wrap">
            <span class="w-full">{{ruleMode === 'edit rule' ? 'Edit rule: \'' + ruleEdit + '\'' : ruleMode?.capitalize()}}</span>
            <div class="border-b border-gray-200 w-full -mt-3">
              <span class="text-sm">Section: <strong>{{section.name}}</strong></span>
            </div>
          </div>
          <form #r="ngForm">
            <div class="w-full">
              <!-- Name -->
              <app-input-text
                [id] = "'rule-name'"
                [form] = "r"
                [classList]="'mt-4'"
                [(value)] = "ruleToManage.name"
                [placeholder]="'e.g. Amphitheatre Lover, Lab Master ...'"
                [topLabel]="'Rule Name'"
                [pattern]="'(?!^\\d+$)^.+$'"
                [patternErrorMessage]="'Rule name can\'t be composed of only numbers'"
                [helperText]="'Name of the rule'"
                [helperPosition]="'right'"
                [required]="true"
                [maxLength]="60"
                [maxLengthErrorMessage]="'Rule name is too long: maximum of 60 characters'">
              </app-input-text>

              <app-input-textarea
                [id] = "'rule-description'"
                [classList]="'mt-4'"
                [form] = "r"
                [(value)] = "ruleToManage.description"
                [placeholder]="'Write here a small description for this rule ...'"
                [helperText]="'Small description of what the rule does'"
                [helperPosition]="'right'"
                [label] = "'Rule Description'"
                [required]="false"
                [maxLength]="65535"
                [maxLengthErrorMessage]="'Rule description is too long: maximum of 65 535 characters'">
              </app-input-textarea>

              <app-input-select *ngIf="nameTags"
                                [id]="'tag-rules'"
                                [form]="r"
                                [classList]="'mt-4'"
                                [(value)]="ruleToManage.tags"
                                [options]="nameTags"
                                [multiple] = "true"
                                [closeOnSelect]="false"
                                [placeholder]="'Select tags to assign this rule to'"
                                [helperText]="'Tags that will be assigned this rule'"
                                [helperPosition]="'right'"
                                [topLabel]="'Rule tags'"
                                (valueChange)="ruleToManage.tags = $event ?? []; updateTags(ruleToManage.tags)"
                                [setData]="setTags">
              </app-input-select>
              <span class="text-xs pl-1">Tags' colors will only appear in table</span>

              <div class="flex flex-wrap">
                <div class="w-1/2 pr-1">
                  <app-input-code
                    [id]="'rule-when'"
                    [classList]="'mt-4'"
                    [title]="'When'"
                    [customFunctions]="functions"
                    [placeholder]="'Rule \'When\' clause'"
                    [value]="ruleToManage.whenClause"
                    [helperText]="'Preconditions that will trigger the rule'"
                    [helperPosition]="'right'"
                    [mode]="'python'"
                    [showOutput]="false"
                    (valueChange)="ruleToManage.whenClause = $event"
                  ></app-input-code>
                </div>
                <div class="w-1/2 pl-1">
                  <app-input-code
                    [id]="'rule-then'"
                    [classList]="'mt-4'"
                    [title]="'Then'"
                    [customFunctions]="functions"
                    [placeholder]="'Rule \'Then\' clause'"
                    [value]="ruleToManage.thenClause"
                    [helperText]="'Code that will be ran once the rule preconditions have met'"
                    [helperPosition]="'right'"
                    [mode]="'python'"
                    [showOutput]="false"
                    (valueChange)="ruleToManage.thenClause = $event"
                  ></app-input-code>
                </div>
              </div>

              <app-input-code
                  [id]="'rule-tools'"
                  [classList]="'mt-4'"
                  [title]="'Additional Tools'"
                  [value]="metadata"
                  [placeholder]="'Autogame global variables:'"
                  [helperText]="'Extra tools to help with the rule edition'"
                  [helperPosition]="'right'"
                  [tabNames]="['Metadata', 'Output']"
                  (valueChange)="changeMetadata($event)"
                  (output)="previewRule($event)"
              ></app-input-code>

              <!-- Alert for metadata changes -->
              <div *ngIf="showAlert" class="justify-center flex flex-wrap mt-4">
                <div class="alert alert-warning shadow-md">
                  <ng-icon name="tabler-alert-triangle" size="2rem"></ng-icon>
                  <div><span>Keep in mind that <strong>metadata is global</strong>. Changing it will <strong>change metadata for the entire course</strong>,
                    which includes <strong>others rules</strong> as well.</span></div>
                </div>
              </div>

              <!--<div class="w-full flex flex-wrap items-end" *ngIf="!refreshing && nameTags">
                <div class="w-4/5 pr-1">
                  <app-input-select
                    [id]="'tag-rules'"
                    [form]="r"
                    [classList]="'mt-4'"
                    [(value)]="ruleToManage.tags"
                    [options]="nameTags"
                    [multiple] = "true"
                    [closeOnSelect]="false"
                    [placeholder]="'Select tags to assign this rule to'"
                    [topLabel]="'Rule tags'"
                    (valueChange)="ruleToManage.tags = $event ?? []; updateTags(ruleToManage.tags)"
                    [setData]="setTags">
                  </app-input-select>
                </div>
                <div class="w-1/5 pl-1">
                  <button class="w-full items-center btn btn-secondary rounded rounded-lg gap-2" (click)="prepareModal('add tag')">
                    <ng-icon name="feather-plus-circle" size="1.2rem"></ng-icon> Add new tag
                  </button>
                </div>

                <div *ngIf="refreshing" class="flex justify-center items-center">
                  <app-spinner></app-spinner>
                </div>

              </div>-->
            </div>
          </form>

          <!-- Actions -->
          <div class="card-actions justify-end mt-4">

            <button type="submit" class="btn btn-primary" (click)="discardModal()">
              <!-- Spinner -->
              <ng-container *ngIf="loading.action">
                <app-spinner [size]="'sm'" [color]="'primary-content'" [classList]="'mr-3'"></app-spinner>
              </ng-container>
              Discard changes
            </button>

            <button type="submit" class="btn btn-primary" (click)="r.onSubmit(null); doAction(ruleMode)">
              <!-- Spinner -->
              <ng-container *ngIf="loading.action">
                <app-spinner [size]="'sm'" [color]="'primary-content'" [classList]="'mr-3'"></app-spinner>
              </ng-container>
              Save and Close
            </button>
          </div>

        </div>
      </div>
    </div>


    <!-- Spinner -->
    <div *ngIf="!section.showTable || refreshing" class="flex justify-center items-center">
      <app-spinner></app-spinner>
    </div>

    <!-- Loader -->
    <app-loader [loading]="loading.page"></app-loader>
  </ng-container>
</div>

<!-- Discard changed Modal -->
<app-modal
   [id]="'exit-management'"
   [templateRef]="EXIT_MANAGEMENT"
   [size]="'md'"
   [header]="'Discard changes?'"
   [submitBtnText]="'Discard'"
   [closeBtnText]="'Cancel'"
   [actionInProgress] = "loading.action"
   (submitBtnClicked)="exitManagement()"
   [xButton]="false"
   [static]="true">
</app-modal>
<ng-template #EXIT_MANAGEMENT>
  <div class="w-full flex flex-wrap">
    <span class="w-full">There are currently <strong>unsaved changes</strong>. This action <strong>cannot be undone</strong>.</span>
    <span class="w-full">Do you want to proceed?</span>
  </div>
</ng-template>

<!-- Delete rule Modal -->
<app-simple-modal *ngIf="ruleMode === 'remove rule' && ruleToManage"
  [id]="'delete-rule'"
  [title]="ruleMode?.capitalize() + ' \'' + (ruleToManage.name)?.capitalize() + '\'?'"

  [text]="'Are you sure you want to remove rule \'' + ruleToManage?.name +
          '\' from this section? You won\'t be able to undo this action.'"
  [submitBtnText]="'Remove'"
  [submitBtnColor]="'error'"
  [actionInProgress]="loading.action"
  (submitBtnClicked)="doAction(ruleMode)"
  (onClose)="ruleToManage = null">
</app-simple-modal>

<!-- Import Modal -->
<app-modal
  [id]="'import'"
  [templateRef]="IMPORT"
  [header]="'Import rules'"
  [submitBtnText]="'Import'"
  [actionInProgress]="loading.action"
  (submitBtnClicked)="fImport.onSubmit(null); importRules()"
  (onClose)="resetImport()"
></app-modal>
<ng-template #IMPORT>
  <div class="prose flex items-center gap-1 mb-3">
    <p class="mb-0">Upload a .CSV file containing user information</p>
    <app-import-helper
      [id]="'import-helper'"
      [format]="'.csv'"
      [requirements]="[
        'The separator must be comma.',
        'The encoding must be UTF-8.'
      ]"
      [csvHeaders]="['name', 'description', 'whenClause', 'thenClause', 'position', 'isActive', 'tags']"
      [csvRows]="[['Lab Master', 'Rule for assigning awards when student excels at the labs', '(TODO) when something', '(TODO) trigger something else', '0', 'true', '1,2']]">
    </app-import-helper>

  </div>

    <form #fImport="ngForm">
      <!-- File -->
      <app-input-file
        [id]="'import-file'"
        [form]="fImport"
        [accept]="['.csv', '.txt']"
        [size]="'sm'"
        [color]="'primary'"
        [required]="true"
        (valueChange)="onFileSelected($event, 'file')">
      </app-input-file>

      <!-- Replace -->
      <app-input-checkbox
        [id]="'import-replace'"
        [form]="fImport"
        [(value)]="importData.replace"
        [color]="'secondary'"
        [classList]="'mt-2'"
        [label]="'Replace duplicates'"
        [labelPosition]="'right'">
      </app-input-checkbox>

    </form>
</ng-template>
