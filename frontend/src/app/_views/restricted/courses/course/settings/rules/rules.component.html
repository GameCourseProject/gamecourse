<div class="w-full relative">
  <!-- Header -->
  <app-header [title]="'Rules'" [icon]="'tabler-clipboard-list'"
              [loading]="loading.action"></app-header>

  <!-- Search -->
  <app-input-search
    [id] = "'sections-search'"
    [items] = "sections"
    [classList]="'lg:w-1/2 mx-auto'"
    (onSearch)="filteredSections = $event">
  </app-input-search>

  <!-- Top Actions
    //, dropdown: [
    //  {action: 'Create new section', icon:'tabler-new-section'},
    //  {action: 'Create new rule', icon: 'tabler-clipboard-list'}]
    // }]"
  -->
  <app-top-actions
    [leftActions]="[
      {action: Action.IMPORT, icon:'jam-download'},
      {action: Action.EXPORT, icon:'jam-upload'}
    ]"
    [rightActions]="[{action: 'Create new section', icon: 'feather-plus-circle', color: 'primary'}]"
    (btnClicked)="doAction($event)">
  </app-top-actions>

  <!-- Sections and Rules -->
  <div *ngFor="let section of sections">
    <app-header [subHeader]="true" [title]="section.name" [classList]="'mt-10'"></app-header>

    <div class="w-full relative">
      <ng-container *ngIf="!loading.page">
        <div *ngFor="let section of filterSections(section)">
          <!-- Actions for rules -->
          <app-top-actions
          [leftActions]="[
                {action: Action.IMPORT, icon:'jam-download'},
                {action: Action.EXPORT, icon:'jam-upload'}
              ]"
          [rightActions]="[{action: 'Create new rule', icon: 'feather-plus-circle', color: 'primary'}]"
          (btnClicked)="doAction($event, section)">
          </app-top-actions>

          <!-- Section Table -->
          <app-table
              [id] = "'rules'"
              [classList]="'mt-5'"
              [headers] = "headers"
              [data] = "data"
              [options] = "tableOptions"
              [loading] = "loading.table"
              (btnClicked)="doActionOnTable($event.type, $event.row, $event.col)"
              (valueChanged)="doActionOnTable('add rule', $event.row, $event.col, $event.value)">
            </app-table>

          <!-- Loader -->
          <app-loader [loading]="loading.page"></app-loader>

        <span *ngIf="filterSections(section).length === 0" class="text-error px-4">No Sections</span>
        </div>
      </ng-container>
    </div>
  </div>
</div>


<!-- New / Edit section modal -->
<app-modal *ngIf="mode && sectionToManage"
  [id]="'manage-section'"
  [templateRef]="MANAGE_SECTION"
  [size]="'lg'"
  [header]="mode?.capitalize()"
  [actionInProgress] = "loading.action"
  (submitBtnClicked)="f.onSubmit(null); mode === 'add section' ? createSection() : editSection()">
</app-modal>

<ng-template #MANAGE_SECTION>
  <form #f="ngForm">
    <div class="w-full flex-wrap mt-3">
      <app-input-text
        [id] = "'section-name'"
        [form] = "f"
        [(value)] = "sectionToManage.name"
        [placeholder]="'Section Name'"
        [topLabel]="'Name'"
        [pattern]="'(?!^\\d+$)^.+$'"
        [patternErrorMessage]="'Section name can\'t be composed of only numbers'"
        [required]="true"
        [maxLength]="60"
        [maxLengthErrorMessage]="'Section name is too long: maximum of 60 characters'">
      </app-input-text>
    </div>
  </form>
</ng-template>

<!-- New / Edit rule modal -->
<app-modal *ngIf="mode && ruleToManage"
           [id]="'manage-rule'"
           [templateRef]="MANAGE_RULE"
           [size]="'lg'"
           [header]="'[Section ' + findSectionName(ruleToManage) + '] : ' + mode?.capitalize()"
           [actionInProgress] = "loading.action"
           (submitBtnClicked)="f.onSubmit(null); mode === 'add rule' ? createRule() : editRule()"
           (onClose)="resetRuleManage()">
</app-modal>


<ng-template #MANAGE_RULE>
  <form #f="ngForm">

    <div class="flex flex-wrap mt-3">

      <div class="w-full sm:pr-7">
        <!-- Name -->
        <app-input-text
          [id] = "'rule-name'"
          [form] = "f"
          [(value)] = "ruleToManage.name"
          [placeholder]="'Rule Name'"
          [topLabel]="'Name'"
          [pattern]="'(?!^\\d+$)^.+$'"
          [patternErrorMessage]="'Rule name can\'t be composed of only numbers'"
          [required]="true"
          [maxLength]="60"
          [maxLengthErrorMessage]="'Rule name is too long: maximum of 60 characters'">
        </app-input-text>
      </div>
      <div class="w-full sm:pr-7 mt-3">
        <!-- Description -->
        <app-input-textarea
          [id] = "'rule-description'"
          [form] = "f"
          [(value)] = "ruleToManage.description"
          [placeholder]="'Rule Description'"
          [label] = "'Description'"
          [required]="false"
          [maxLength]="100"
          [maxLengthErrorMessage]="'Rule description is too long: maximum of 100 characters'">
        </app-input-textarea>
      </div>

      <div class="w-full flex flex-wrap mt-3" style="align-items: flex-end">
        <div class="sm:w-10/12">
          <!-- Tags -->
          <app-input-select
            [id]="'rule-tags'"
            [form] = "f"
            [(value)] = "ruleToManage.tags"
            [options] = "getTagsNames()"
            [multiple] = "true"
            [search]="false"
            [placeholder]="'Rule Tags'"
            [topLabel]="'Tags'"
            [required]="false">
          </app-input-select>
        </div>

        <div class="sm:w-2/12 sm:pl-3">
          <button class="btn btn-md btn-primary">Add new tag</button>
        </div>
      </div>
    </div>
  </form>
</ng-template>


<!--
<div class="w-full sm:w-1/2 sm:pr-12">
  When
  <app-input-text
    [id]="'rule-when'"
    [form] = "f"
    [(value)] = "ruleToManage.when"
    [placeholder]="'Rule When Clause'"
    [topLabel]="'When'">
  </app-input-text>

  Then
  <app-input-text
    [id]="'rule-then'"
    [form] = "f"
    [(value)] = "ruleToManage.then"
    [placeholder]="'Rule Then Clause'"
    [topLabel]="'Then'">
  </app-input-text>
</div>-->
