<div class="w-full relative">
  <!-- Header -->
  <app-header [title]="'Rules'" [icon]="'tabler-clipboard-list'"
              [loading]="loading.action"></app-header>

  <!-- Search -->
  <app-input-search
    [id] = "'sections-search'"
    [items] = "sections"
    [classList]="'lg:w-1/2 mx-auto'"
    (onSearch)="filteredSections = $event">
  </app-input-search>

  <!--
    [leftActions]="[
      {action: Action.IMPORT, icon:'jam-download'},
      {action: Action.EXPORT, icon:'jam-upload'}
    ]"
  -->

  <div class="py-6 border-b-2 border-gray-300 ">
    <app-top-actions
      [rightActions]="[{action: 'Add new section', icon: 'feather-plus-circle', color: 'primary'}]"
      (btnClicked)="doAction($event)">
    </app-top-actions>
  </div>

  <!-- Sections and Rules -->
  <div *ngFor="let section of sections">
    <app-header [subHeader]="true" [title]="section.name" [icon] ="'jam-box'" [classList]="'mt-10'"></app-header>

    <div class="w-full relative">
      <ng-container *ngIf="!loading.page">
        <div *ngFor="let section of filterSections(section)">
          <!-- Actions for rules -->
          <app-top-actions
            [rightActions]="[{action: 'Create rule', icon: 'tabler-clipboard-list', color: 'primary', outline: true},
                             {action: 'Import / Export', icon: 'tabler-arrows-up-down', color: 'primary', outline: true,  dropdown: [
                              {action: Action.IMPORT + ' rule', icon:'jam-download'},
                              {action: Action.EXPORT + ' all rules', icon:'jam-upload'}
                            ]}]"
            (btnClicked)="doAction($event, section)">
          </app-top-actions>

          <!-- Section Table -->
          <app-table
              [id] = "'rules'"
              [classList]="'mt-5'"
              [headers] = "headers"
              [data] = "data"
              [options] = "tableOptions"
              [loading] = "loading.table"
              (btnClicked)="doActionOnTable($event.type, $event.row, $event.col)"
              (valueChanged)="doActionOnTable('value changed rule', $event.row, $event.col, $event.value)">
            </app-table>

          <!-- Loader -->
          <app-loader [loading]="loading.page"></app-loader>

        <span *ngIf="filterSections(section).length === 0" class="text-error px-4">No Sections</span>
        </div>
      </ng-container>
    </div>
  </div>
</div>


<!-- New / Edit section modal -->
<app-modal *ngIf="mode && sectionToManage"
  [id]="'manage-section'"
  [templateRef]="MANAGE_SECTION"
  [size]="'md'"
  [header]="mode?.capitalize()"
  [actionInProgress] = "loading.action"
  (submitBtnClicked)="f.onSubmit(null); createSection()"
  (onClose)="resetSectionManage()">
</app-modal>

<ng-template #MANAGE_SECTION>
  <form #f="ngForm">
    <div class="w-full flex-wrap mt-3">
      <app-input-text
        [id] = "'section-name'"
        [form] = "f"
        [(value)] = "sectionToManage.name"
        [placeholder]="'Section Name'"
        [topLabel]="'Name'"
        [pattern]="'(?!^\\d+$)^.+$'"
        [patternErrorMessage]="'Section name can\'t be composed of only numbers'"
        [required]="true"
        [maxLength]="60"
        [maxLengthErrorMessage]="'Section name is too long: maximum of 60 characters'">
      </app-input-text>
    </div>
  </form>
</ng-template>

<!-- New / Edit rule modal -->
<app-modal *ngIf="mode && ruleToManage"
           [id]="'manage-rule'"
           [templateRef]="MANAGE_RULE"
           [size]="'lg'"
           [header]="mode?.capitalize() + ' to \'' + findSectionName(ruleToManage) + '\' :' "
           [actionInProgress] = "loading.action"
           (submitBtnClicked)="f.onSubmit(null); createRule()"
           (onClose)="resetRuleManage()">
</app-modal>

<ng-template #MANAGE_RULE>
  <form #r="ngForm">

    <div class="flex flex-wrap mt-3">

      <div class="w-full border-b-2 border-gray-300">
      <div class="w-full sm:pr-7">
        <!-- Name -->
        <app-input-text
          [id] = "'rule-name'"
          [form] = "r"
          [(value)] = "ruleToManage.name"
          [placeholder]="'Rule Name'"
          [topLabel]="'Name'"
          [pattern]="'(?!^\\d+$)^.+$'"
          [patternErrorMessage]="'Rule name can\'t be composed of only numbers'"
          [required]="true"
          [maxLength]="60"
          [maxLengthErrorMessage]="'Rule name is too long: maximum of 60 characters'">
        </app-input-text>
      </div>
      <div class="w-full sm:pr-7 mt-3">
        <!-- Description -->
        <app-input-textarea
          [id] = "'rule-description'"
          [form] = "r"
          [(value)] = "ruleToManage.description"
          [placeholder]="'Rule Description'"
          [label] = "'Description'"
          [required]="false"
          [maxLength]="100"
          [maxLengthErrorMessage]="'Rule description is too long: maximum of 100 characters'">
        </app-input-textarea>
      </div>

      <div class="w-full flex flex-wrap mt-3" style="align-items: flex-end">
        <div class="sm:w-10/12">
          <!-- Tags -->
          <app-input-select
            [id]="'rule-tags'"
            [form] = "r"
            [(value)] = "ruleToManage.tags"
            [options] = "getTagNames(ruleToManage.tags)"
            [multiple] = "true"
            [search]="false"
            [placeholder]="'Select tags for rule'"
            [topLabel]="'Tags'"
            [required]="false">
          </app-input-select>
        </div>

        <div class="sm:w-2/12 sm:pl-3">
          <button type="button" class="btn-md rounded-lg btn-primary" (click) = "doAction('add tag')">Add new tag</button>
        </div>

        <p class="pl-1 pb-16"><small> Tag colors will only show in table</small></p>

      </div>
      </div>

      <div class="w-full flex flex-wrap mt-16" style="align-items: flex-end">
        <!-- When clause -->
        <div class="sm:w-1/2">
          <app-input-text
            [id]="'rule-whenClause'"
            [form] = "r"
            [(value)] = "ruleToManage.whenClause"
            [placeholder]="'Rule When Clause'"
            [required]="true"
            [topLabel]="'When'">
          </app-input-text>
       </div>

        <!-- Then clause -->
        <div class="sm:w-1/2 sm:pl-3 sm:pr-5">
          <app-input-text
            [id]="'rule-thenClause'"
            [form] = "r"
            [(value)] = "ruleToManage.thenClause"
            [placeholder]="'Rule Then Clause'"
            [required]="true"
            [topLabel]="'Then'">
          </app-input-text>
       </div>
      </div>
    </div>
  </form>
</ng-template>

<!-- New / Edit tag modal -->
<app-modal *ngIf="mode && tagToManage"
           [id]="'manage-tag'"
           [templateRef]="MANAGE_TAG"
           [size]="'md'"
           [header]="mode?.capitalize()"
           [actionInProgress] = "loading.action"
           [submitBtnText] = "'Done'"
           (submitBtnClicked)="t.onSubmit(null); createTag();"
           (closeBtnClicked)="resetTagManage();">
</app-modal>

<ng-template #MANAGE_TAG>
  <form #t="ngForm">
    <div class="w-full flex flex-wrap mt-3">

      <!--<div *ngIf="this.selectedTags?.length > 0" class="w-full justify-center pb-3">
        <p>Your tags:</p>
        <ng-container *ngFor="let tag of this.selectedTags">
            <div class="inline-flex items-center rounded-lg py-1
                    px-2 mr-2 text-sm bg-{{tag.color}} text-white">{{ tag.name }}
              <button type="button"
                      (click)="removeTag(tag)"
                      class="inline-flex items-center p-0.5 ml-2 text-sm
                      bg-transparent rounded-lg hover:bg-blue-200 hover:text-blue-900
                      dark:hover:bg-blue-300 dark:hover:text-blue-900">
                <ng-icon name="feather-x" color="white" size="1rem" class="text-info"></ng-icon>
              </button>
            </div>
        </ng-container>
      </div>-->

      <div class="w-full flex flex-wrap" style="align-items: self-end">
        <!-- Tag Name -->
        <div class="sm:w-1/2 sm:pr-3">
          <app-input-text
            [id] = "'tag-name'"
            [form] = "t"
            [(value)] = "tagToManage.name"
            [placeholder]="'Tag Name'"
            [topLabel]="'Name'"
            [pattern]="'(?!^\\d+$)^.+$'"
            [patternErrorMessage]="'Name name can\'t be composed of only numbers'"
            [required]="true"
            [maxLength]="60"
            [maxLengthErrorMessage]="'Rule name is too long: maximum of 60 characters'">
          </app-input-text>
        </div>

        <!-- Tag Color -->
        <div class="sm:w-1/2 sm:pr-3">
          <app-input-select
            [id]="'tag-color'"
            [form] = "t"
            [(value)] = "tagToManage.color"
            [options] = "getColors()"
            [multiple] = "false"
            [search]="false"
            [placeholder]="'Choose a color'"
            [topLabel]="'Tag Color'"
            [required]="true">
          </app-input-select>
        </div>

        <!--<div class="sm:w-1/6">
          <button type="button" class="btn-md rounded-lg btn-primary" (click) = "createTag()">Create!</button>
        </div>-->
      </div>
    </div>
  </form>
</ng-template>



<!-- Delete Verification Modal -->
<app-simple-modal *ngIf="ruleToDelete"
                  [id]="'delete-verification'"
                  [title]="'Remove rule'"
                  [text]="'Are you sure you want to remove rule \'' + ruleToDelete?.name + '\' from this section? You won\'t be able to undo this action.'"
                  [submitBtnText]="'Remove'"
                  [submitBtnColor]="'error'"
                  [actionInProgress]="loading.action"
                  (submitBtnClicked)="deleteRule(ruleToDelete)"
                  (onClose)="ruleToDelete = null">
</app-simple-modal>
