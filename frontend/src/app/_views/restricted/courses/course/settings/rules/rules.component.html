<div class="w-full relative">
  <!-- Header -->
  <app-header [classList]="'text-md'"
    [title]="'Rule Editor'"
    [icon]="'tabler-clipboard-list'"
    [loading]="loading.action">
  </app-header>

  <ng-container *ngIf="sectionMode !== 'see section'">

    <div class="flex flex-wrap justify-center">
      <span class="text-base-content text-xl font-semibold">Existing Sections</span>
    </div>

    <!-- Search -->
    <app-input-search
      [id] = "'sections-search'"
      [items] = "originalSections"
      [classList]="'w-[55%] mx-auto mt-5'"
      [placeholder]="'Search for specific section...'"
      (onSearch)="filteredSections = $event">
    </app-input-search>

    <span *ngIf="originalSections.length === 0" class="p-32 text-base-content text-opacity-50 flex flex-wrap justify-center">Nothing to show yet.</span>

    <!-- Sections and Rules -->
    <div *ngFor="let section of originalSections">
      <div class="justify-center flex">
        <div class="card w-[55%] bg-base-100 shadow-xl mt-5">
          <div class="card-body">
            <ng-container *ngIf="!loading.page">

              <div class="flex items-start mt-2 justify-between">
                <app-header [subHeader]="true" [classList]="'flex flex-wrap items-start'" [title]="section.name" [icon] ="'jam-box'"></app-header>

                <div>
                  <div class="tooltip align-middle mx-1.5" data-tip="Edit">
                    <button class="btn btn-sm btn-ghost btn-circle" (click)="prepareManagement('edit section', section)">
                      <ng-icon name="jam-pencil-f" size="1.5rem" class="text-warning"></ng-icon>
                    </button>
                  </div>

                  <div class="tooltip align-middle mx-1.5" data-tip="Delete">
                    <button class="btn btn-sm btn-ghost btn-circle" (click)="prepareManagement('remove section', section)">
                      <ng-icon name="jam-trash-f" size="1.5rem" class="text-error"></ng-icon>
                    </button>
                  </div>

                  <div class="tooltip align-middle mx-1.5" data-tip="See more details">
                    <button class="btn btn-sm btn-ghost btn-circle" (click)="prepareManagement('see section', section)">
                      <ng-icon name="feather-arrow-right-circle" size="1.5rem" class="text-primary"></ng-icon>
                    </button>
                  </div>
                </div>

              </div>

              <!-- Loader -->
              <app-loader [loading]="loading.page"></app-loader>

            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <div class="justify-center flex flex-wrap">
      <div *ngFor="let action of sectionActions" class="flex flex-wrap items-center justify-center">
        <button class="flex items-center btn btn-{{action.color}} rounded rounded-lg mx-1.5 mt-5 {{action.disable ? 'btn-disabled' : ''}}"
                (click)="prepareManagement(action.action)">
          <ng-icon name="{{action.icon}}" size="{{ action.action === 'add section' ? '1.2rem' : '1.5rem' }}" class="mr-0.5"></ng-icon>
          {{action.action}}
        </button>
      </div>
    </div>

    <!--<div class="mb-5">
      <app-top-actions
        [rightActions]="sectionActions"
        (btnClicked)="prepareManagement($event)">
      </app-top-actions>
    </div>-->
  </ng-container>

  <!-- Sections Management -->
  <app-rule-sections-management
    [mode]="sectionMode"
    [course] = "course"
    [courseRules]="courseRules"
    [section]="section"
    [tags]="tags"
    (newCourseRules)="closeSectionManagement($event)">
  </app-rule-sections-management>

</div>

<!-- Tags Management -->
<app-rule-tags-management
  *ngIf="tagMode"
  [course] = "course"
  [mode] = "tagMode"
  [tags] = "tags"
  (newTags)="this.tags = $event; tagMode = null;"
  [rules] = "courseRules"
  (newRules) = "assignRules($event)"
></app-rule-tags-management>

<!-- New / Edit section modal -->
<app-modal *ngIf="sectionMode && sectionToManage"
           [id]="'manage-section'"
           [templateRef]="MANAGE_SECTION"
           [size]="'md'"
           [header]="sectionMode?.capitalize()"
           [submitBtnText]="sectionMode?.capitalize()"
           [actionInProgress] = "loading.action"
           (submitBtnClicked)="s.onSubmit(null); doAction(sectionMode)"
           (onClose)="resetSectionManage()">
</app-modal>
<ng-template #MANAGE_SECTION>
  <form #s="ngForm">
    <div class="w-full flex-wrap mt-3">
      <app-input-text
        [id] = "'section-name'"
        [form] = "s"
        [(value)] = "sectionToManage.name"
        [placeholder]="'Section Name'"
        [topLabel]="'Name'"
        [pattern]="'(?!^\\d+$)^.+$'"
        [patternErrorMessage]="'Section name can\'t be composed of only numbers'"
        [required]="true"
        [maxLength]="60"
        [maxLengthErrorMessage]="'Section name is too long: maximum of 60 characters'">
      </app-input-text>
    </div>
  </form>
</ng-template>

<!-- Manage sections priorities -->
<app-modal *ngIf="sectionMode === 'manage sections priority'"
           [id] = "'manage-sections-priority'"
           [templateRef]="MANAGE_SECTION_PRIORITY"
           [size] = "'lg'"
           [header] = "sectionMode?.capitalize()"
           [submitBtnText]="'Save'"
           [closeBtnText]="'Discard changes'"
           [actionInProgress] = "loading.action"
           (submitBtnClicked)="saveSectionPriority()">
</app-modal>
<ng-template #MANAGE_SECTION_PRIORITY>
  <!-- Description -->
  <div class="w-full flex flex-wrap -mt-1">
    <span>GameCourse's Rule System is arranged by a <strong>set of sections that have rules</strong> inside them.
      The designated order amongst sections <strong>specifies the priority</strong> of each of them. This means that the <strong>first sections will
      execute earlier</strong> than the rest.</span>
    <span class="mt-2">Therefore, keep in consideration in case there's any type of <strong>dependency between each one of them</strong>.</span>
  </div>

  <div cdkDropList [id]="'sections-list'" class="dd max-w-none ml-16 mt-8" (cdkDropListDropped)="drop($event)">
    <div class="dd-item" *ngFor="let section of sections" cdkDrag>
      <div class="flex items-center mb-3">
        <div class="flex items-center w-[calc(100%-6rem)]">
          <!-- Move -->
          <div class="tooltip align-middle absolute -left-10" data-tip="Move">
            <button class="dd-handle btn btn-sm btn-ghost btn-circle hover:text-base-content m-0 relative cursor-grab">
              <ng-icon name="tabler-arrows-vertical" size="1.2rem">
              </ng-icon>
              <div class="dd-handle overlay h-[1.2rem] w-[1.2rem]"></div>
            </button>
          </div>

          <!-- Section -->
          <div class="dd-content border-primary border-opacity-75 text-primary font-semibold">
            {{section.name}}
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Remove section -->
<app-simple-modal *ngIf="sectionMode && sectionToManage"
                  [id]="'remove section'"
                  [title]="sectionMode?.capitalize() + ' \'' + (sectionToManage.name)?.capitalize() + '\'?'"

                  [text]="'Are you sure you want to remove section \'' + sectionToManage?.name +
                          '\' and its current rules? You won\'t be able to undo this action.'"
                  [submitBtnText]="'Remove'"
                  [submitBtnColor]="'error'"
                  [actionInProgress]="loading.action"
                  (submitBtnClicked)="doAction(sectionMode)">
</app-simple-modal>
